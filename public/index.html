<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">

	<title>DNA Sequence Visualization</title>

	<!-- Bootstrap 4 CSS -->
	<link rel="stylesheet" type="text/css" href="client/bootstrap.min.css" />

	<!-- Project CSS -->
	<link rel="stylesheet" type="text/css" href="client/style.css" />

</head>

<body>
	<nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
		<div class="container">
			<a class="navbar-brand" href="/">Team TBD</a>
			<ul class="navbar-nav mr-auto">
				<li class="nav-item">
					<a class="nav-link active" href="/">
						DNA Visualization
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="about.html">
						About Us
					</a>
				</li>
			</ul>
		</div>
	</nav>
	<div class="container">
		<h2>Visualizing DNA Sequences</h2>
		<br>
		<p>
			This visualization was created as an aid to detect errors in DNA sequences, as well as compare DNA
			sequences across different species.
		</p>

		<div id="my_dataviz"></div>
	</div>

	<!-- JavaScript For Bootstrap 4 -->
	<script src="client/jquery.slim.min.js"></script>
	<script src="client/popper.min.js"></script>
	<script src="client/bootstrap.min.js"></script>

	<!-- D3 JS -->
	<script src="client/d3.min.js"></script>
	<script src="https://d3js.org/d3.v4.js"></script>

	<!-- <script src="https://d3js.org/d3.v4.js"></script> -->

	<!-- Project JS -->
	<script>

	// randomly generated N = 40 length array 0 <= A[N] <= 39
	var seqScores1 = Array.from({length: 40}, () => Math.floor(Math.random() * 40));

	var data = [
		{
			seqId: "AACTA2215-20",
			species: "Tachystola",
			seqChars: "--------LYFIFGIWAGMVGT----SLSLLIRAELGNP--------GSLIGDDQI-------YNTIVTAHAFIMIFFMVMPIMIGGFGNW---------",
			seqScores: seqScores1
		},
		{
			seqId: "AACTA2452-20",
			species: "Cortinicara",
			seqChars: "--------LYFIFGIWAGMVGT----SLSLLIRAELGNP--------GSLIGDDQI-------YNTIVTAHAFIMIFFMVMPIMIGGFGNW---------",
			seqScores: seqScores1
		}
	]

	// set the dimensions and margins of the graph
	var margin = {top: 10, right: 30, bottom: 30, left: 60},
	width = 1000 - margin.left - margin.right,
	height = 500 - margin.top - margin.bottom;

	// append the svg object to the body of the page
	var svg = d3.select("#my_dataviz")
	.append("svg")
	.attr("width", width + margin.left + margin.right)
	.attr("height", height + margin.top + margin.bottom)
	.append("g")
	.attr("transform",
	"translate(" + margin.left + "," + margin.top + ")");

	//Read the data
	d3.csv("https://raw.githubusercontent.com/holtzy/data_to_viz/master/Example_dataset/5_OneCatSevNumOrdered.csv", function(data) {

		// group the data: I want to draw one line per group
		var sumstat = d3.nest() // nest function allows to group the calculation per level of a factor
		.key(function(d) { return d.name;})
		.entries(data);

		// Add X axis --> it is a date format
		var x = d3.scaleLinear()
		.domain(d3.extent(data, function(d) { return d.year; }))
		.range([ 0, width ]);
		var xAxis = svg.append("g")
		.attr("transform", "translate(0," + height + ")")
		.call(d3.axisBottom(x).ticks(5));

		// Add Y axis
		var y = d3.scaleLinear()
		.domain([0, d3.max(data, function(d) { return +d.n; })])
		.range([ height, 0 ]);
		var yAxis = svg.append("g")
		.call(d3.axisLeft(y));

		// color palette
		var res = sumstat.map(function(d){ return d.key }); // list of group names
		var color = d3.scaleOrdinal()
		.domain(res)
		.range(['#e41a1c','#377eb8','#4daf4a','#984ea3','#ff7f00','#ffff33','#a65628','#f781bf','#999999'])

		// Add a clipPath: everything out of this area won't be drawn.
    	var clip = svg.append("defs").append("svg:clipPath")
        .attr("id", "clip")
        .append("svg:rect")
        .attr("width", width )
        .attr("height", height )
        .attr("x", 0)
        .attr("y", 0)

		// Add brushing
    	var brush = d3.brushX()              // Add the brush feature using the d3.brush function
        .extent( [ [0,0], [width,height] ] ) // initialise the brush area: start at 0,0 and finishes at width,height: it means I select the whole graph area
        .on("end", updateChart)              // Each time the brush selection changes, trigger the 'updateChart' function

		var main = svg.append('g')
		.attr("clip-path", "url(#clip)")

		// Draw the line
		main.selectAll(".line")
		.data(sumstat)
		.enter()
		.append("path")
		.attr("fill", "none")
		.attr("stroke", function(d){ return color(d.key) })
		.attr("stroke-width", 1.5)
		.attr("d", function(d){
			return d3.line()
			.x(function(d) { return x(d.year); })
			.y(function(d) { return y(+d.n); })
			(d.values)
		})
		.on("mouseover", function () {
    		d3.select(this).style("stroke-width", 5);
		})
		.on("mouseout", function () {
    		d3.select(this).style("stroke-width", 2);
		})
		.on("click", function () {
    		d3.select(this).attr("stroke", function(d){
				return color("#000000")
			});
		});

		// Add the brushing
		main
    	.append("g")
      	.attr("class", "brush")
      	.call(brush);

		// A function that set idleTimeOut to null
  		var idleTimeout;
  		function idled() { idleTimeout = null; }

  		// A function that update the chart for given boundaries
  		function updateChart() {

    		extent = d3.event.selection

    		// If no selection, back to initial coordinate. Otherwise, update X axis domain
    		if(!extent){
      			if (!idleTimeout) return idleTimeout = setTimeout(idled, 350); // This allows to wait a little bit
      				x.domain([ 4,8])
    		} else {
      			x.domain([ x.invert(extent[0]), x.invert(extent[1]) ])
      			main.select(".brush").call(brush.move, null) // This remove the grey brush area as soon as the selection has been done
    		}

			// Update axis and line position
	    	xAxis.transition().duration(1000).call(d3.axisBottom(x))
	    	main
	      	.selectAll(".line")
	      	.transition().duration(1000)
			.attr("d", function(d){
				return d3.line()
				.x(function(d) { return x(d.year); })
				.y(function(d) { return y(+d.n); })
				(d.values)
			})
		}
	})

	</script>
</body>

</html>
